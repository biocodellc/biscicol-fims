buildscript {
    repositories {
        maven {
            url "http://repo.biocodellc.com/repository/maven-private/"
            credentials {
                username mavenUser
                password mavenPass
            }
        }
        mavenLocal()
    }
    dependencies {
        classpath "org.biocode:gradle-fims:1.1.8"
    }
}

apply plugin: "application"
apply plugin: "org.biocode.fims-web"

import org.biocode.gradle.web.tasks.RestartRemoteJettyTask
import org.biocode.gradle.web.tasks.HotDeployRemoteJettyTask

ext.fimsCommonsVersion = "0.1.3"
ext.fimsSequencesVersion = "0.1.5"

fims {
    maven {
        username mavenUser
        password mavenPass
    }
}

repositories {
    add(fims.mavenFims())
    mavenLocal()
}

// need to evaluate childProjects first so we can add the childProject server dependencies to the server configuration
evaluationDependsOnChildren()

dependencies {
    server 'org.glassfish.jersey.media:jersey-media-multipart:2.25'

    server('org.glassfish.jersey.ext:jersey-spring3:2.25') {
        exclude module: 'bean-validator'
        exclude module: 'asm-all-repackaged'
    }
    server 'javax.servlet:javax.servlet-api:3.1.0'
    server 'com.fasterxml.jackson.datatype:jackson-datatype-hibernate5:2.6.0'
    server 'com.googlecode.json-simple:json-simple:1.1.1'
    server 'org.springframework.data:spring-data-jpa:1.10.1.RELEASE'
    server group: 'org.hibernate.javax.persistence', name: 'hibernate-jpa-2.1-api', version: '1.0.0.Final'
    server 'org.slf4j:slf4j-log4j12:1.7.19'
    server('org.apache.commons:commons-digester3:3.2') {
        exclude module: 'asm'
    }
    server 'commons-cli:commons-cli:1.2'
//    server group: 'org.eclipse.jetty', name: 'jetty-servlets', version: '9.3.8.v20160314'

    server group: 'org.apache.commons', name: 'commons-io', version: '1.3.2'
    compile composite.resolveDependency("org.biocode:biocode-fims-commons:${fimsCommonsVersion}", ":biocode-fims-commons")
    compile composite.resolveDependency("org.biocode:biocode-fims-sequences:${fimsSequencesVersion}", ":biocode-fims-sequences")

    doclet fileTree(dir: 'swagger', include: ['swagger-doclet-*'])

    additionalSources(group: 'org.springframework.data', name: 'spring-data-commons', version: '1.10.1.RELEASE', classifier: 'sources') {
        transitive = false
    }
    additionalSources(group: 'org.biocode', name: 'biocode-fims-commons', version: "${fimsCommonsVersion}") {
        transitive = false
    }

    testCompile "junit:junit-dep:4.10"
    integrationTestRuntime group: 'org.aspectj', name: 'aspectjweaver', version: '1.8.9'
    // need to use the following until https://github.com/gradle/gradle/issues/1553 is resolved. Then we can update DependencyResolver dependency substitution code
    integrationTestCompile project(path: ":biocode-fims-commons", configuration: "integrationTestOutput")
//    integrationTestCompile composite.resolveDependency("org.biocode:biocode-fims-commons:${fimsCommonsVersion}", "biocode-fims-commons", "integrationTestOutput")

    subprojects.each {
        project.configurations.server.dependencies.addAll(it.configurations.server.dependencies)
        project.configurations.serverRuntime.dependencies.addAll(it.configurations.serverRuntime.dependencies)
    }
}

//=============================
//= ssh configuration
//=============================

// jetty ssh plugin
remotes {
    biscicol {
        host = 'biscicol.org'
        user = biscicolUser
        password = biscicolPassword
    }
}

//=============================
//= application configuration
//=============================
mainClassName = "biocode.fims.run.FimsPostgresMigrator"

distributions {
    main {
        contents {
            into('lib') {
                from configurations.server
            }
        }
    }
}

startScripts {
    classpath = files(jar.archivePath, configurations.server, configurations.runtime)
}

task postgresMigration(type: JavaExec) {
    classpath = configurations.server + configurations.compile + sourceSets.main.runtimeClasspath

    if (project.hasProperty("appArgs")) {
        args Eval.me(appArgs)
    }

    main = "biocode.fims.run.FimsPostgresMigrator"
}

task generateUUIDs(type: JavaExec) {
    classpath = configurations.server + configurations.compile + sourceSets.main.runtimeClasspath

    main = "biocode.fims.run.UserUUIDGenerator"
}


//=============================
//= deployment configuration
//=============================

updateDependencies {
    remote = remotes.biscicol
    location = remoteLibsDirectory
}

updateDependenciesDev {
    remote = remotes.biscicol
    location = remoteDevLibsDirectory
}

deployFims {
    remote = remotes.biscicol
    remoteLibsDir = remoteLibsDirectory
    remoteWarDir = remoteWarDirectory
}

deployFimsDev {
    remote = remotes.biscicol
    remoteLibsDir = remoteDevLibsDirectory
    remoteWarDir = remoteWarDevDirectory
}

deployFimsLocal {
    deployDir = localWarDirectory
}

task hotDeployFimsDev(type: HotDeployRemoteJettyTask, dependsOn: "deployFimsDev") {
    group = 'Fims'
    remoteWarDir = remoteWarDevDirectory
    remote = remotes.biscicol
}

task hotDeployFims(type: HotDeployRemoteJettyTask, dependsOn: "deployFims") {
    group = 'Fims'
    remoteWarDir = remoteWarDirectory
    remote = remotes.biscicol
}

task restartFims(type: RestartRemoteJettyTask) {
    group = 'Fims'
    jettyPath = biscicolJettyPath
    remote = remotes.biscicol
}

task restartFimsDev(type: RestartRemoteJettyTask) {
    group = 'Fims'
    jettyPath = biscicolJettyDevPath
    remote = remotes.biscicol
}

//=============================
//= Rest api docs configuration
//=============================

// TODO move this from the web plugin to the fims plugin
generateRestApiDocs {
    swagger {
        apiInfo = "${projectDir}/swagger/api-info.json"
        apiVersions = ["v1.1", "v2"]
        apiBasePath = "/biocode-fims/rest/"
    }
}

